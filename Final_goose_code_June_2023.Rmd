---
title: "Untitled"
output: html_document
date: "2023-06-14"
---

```{r}
### Libraries
library(dplyr) ### Data manipulation
library(tidyverse) #dataframe manipulation and to remove NAs from columns

########################################################
### Filtering the data
########################################################


### Load USGS data--> File sent directly from Danny Bystrack from request
Geese_Es <- read.csv("~/Desktop/Curley_Ramirez_Geese_Es_202008201701.csv")#1,611,483 obs

### Grab the needed columns 
Goose_data<- Geese_Es %>% select(B_COORD_PRECISION,B_COUNTRY_CODE, B_LAT_DECIMAL_DEGREES, B_LON_DECIMAL_DEGREES, B_SPECIES_ID, B_SPECIES_NAME, BAND_NUM, BANDING_DAY, BANDING_MONTH, BANDING_YEAR, BEARING, DISTANCE, E_COORD_PRECISION, E_COUNTRY_CODE, E_LAT_DECIMAL_DEGREES, E_LON_DECIMAL_DEGREES, ENCOUNTER_MONTH, ENCOUNTER_YEAR, SAME_10_MIN_BLOCK)

### Clean
rm(Geese_Es)

###Grab the species that we want - removed: All Canada Goose species, Barnacle Goose (9 records) Emporer Goose (201), Integrades (Black X Atlantic Brant Intergrade), (Snow X Blue Goose Intergrade ), (Hyrids, Snow X Ross's Goose Hybrid,  Tule White-fronted Goose, ), And "Blue Geese"
Goose_data<-Goose_data%>% filter(B_SPECIES_NAME %in% c("Lesser Snow Goose","Ross's Goose","Greater White-fronted Goose","Cackling Goose","Atlantic Brant","Black Brant", "Greater Snow Goose")) #240,654 obs

###Filter Years (data goes back to 1950)
Goose_data<-Goose_data%>% filter(BANDING_YEAR >= 1990) #140,443 obs
Goose_data<-Goose_data%>% filter(BANDING_YEAR <= 2019) #140,390 obs

###Remove encounter year 2020 because that year was only midway compiled when we requested the data
Goose_data<-Goose_data%>% filter(ENCOUNTER_YEAR <= 2019) #136,452 obs

###Filter months for winter and breeding season
Goose_data<-Goose_data %>% filter(BANDING_MONTH %in% (5:7)) #64,536 obs

Goose_data<-Goose_data%>% filter(ENCOUNTER_MONTH %in% c(12, 1, 2)) #31,472 obs

### Remove species recorded in same 10 block (to remove bias of birds that did not migrate)
Goose_data<-Goose_data%>% filter(SAME_10_MIN_BLOCK %in% "N") #31,468 obs

### Remove data with no distance information (these are usually data from hunters without exact dates)
Goose_data<-Goose_data %>% drop_na(DISTANCE) #31,409 obs

### Remove duplicates (occurs when 2 different people record the same bird at the same time)
Goose_data<-distinct(Goose_data)#31,371 obs

### Remove breeding records below 50 degrees latitude (retain arctic and subarctic records)
Goose_data<-Goose_data%>% filter(B_LAT_DECIMAL_DEGREES >= 50) #30,797 obs

### Only retain birds banded in US and CA
b_country_code<-c("CA", "US")
Goose_data<-Goose_data%>% filter(B_COUNTRY_CODE %in% b_country_code) #28,665 obs

### and remove birds encounter outside of continental N and S america (rm Russa and Japan)
table(Goose_data$E_COUNTRY_CODE)

e_country_code<-c("CA", "US", "MX")
Goose_data<-Goose_data%>% filter(E_COUNTRY_CODE %in% e_country_code) #28,656 obs

### Remove encounter coordinates
## No need to remove Banding precision but double check
#table(Goose_data$B_COORD_PRECISION)
prec_values<-c(0, 1, 10, 11) # categories with higher coordinate resoltuion
Goose_data<-Goose_data%>% filter(E_COORD_PRECISION %in% prec_values) #28,058 obs
### see https://www.pwrc.usgs.gov/BBL/manual/inexact.cfm for definitions

### Check for birds that have more than one record to make sure they don't repeat
more_than_2<-as.data.frame(table(Goose_data$BAND_NUM))
more_than_2<-subset(more_than_2, subset = more_than_2$Freq>=2) #194 bands repeated 2-5 times

### Make a df pulling just these repeated band numbers to filter, but also remove them from Goose df

### Remove these bands from the original dataset and will return once filtered and examined
more_than_2_records<-Goose_data %>%
  filter(BAND_NUM %in% more_than_2$Var1) #423 obs to be examined and filtered

### Remove these bands from the original dataset and will return once filtered and examined
Goose_data<-Goose_data %>%
  filter(!BAND_NUM %in% more_than_2$Var1) #27,635 obs

### Check that the difference in goose df matches 565 records to be filtered
#27635-423=27654 YES

### Group by the unique band numbers and year recorded, then only take the max distance taken from that year
rm_repeats<-as.data.frame(more_than_2_records %>% group_by(BAND_NUM, ENCOUNTER_YEAR) %>% slice_max(DISTANCE, n=1))#377 records

### rbind back to the original dataset
Goose_data<-rbind(Goose_data, rm_repeats) #28,005 obs

### Save filtered dataset (which may require more pruning after plotting)
write.csv(Goose_data, file="Goose_data_filtered_nov2022.csv", row.names = F)

### Clear global environment. Can reload the filtered data set for visualization and plots
write.csv(hm, file="more_than2.csv", row.names = F )


### Lastly, remove birds recorded in dec and following year and take the max
within_season<-as.data.frame(table(Goose_data_filtered_nov2022$BAND_NUM))
within_season<-subset(within_season, subset = within_season$Freq>=2) #138 birds recorded more than 2x

### subset by the unique band numbers
bands<-unique(within_season$Var1)

### Remove these bands from the original dataset and will return once filtered and examined
Goose_data<-Goose_data_filtered_nov2022 %>%
  filter(!BAND_NUM %in% within_season$Var1) #27,729 obs

### SC visually inspected all data and retained the farthest dist traveled
within_season_records<-Goose_data_filtered_nov2022 %>%
  filter(BAND_NUM %in% within_season$Var1) #276 obs (276+27,729 = 28,005 YES)

### upload the pruned dataset 
Pruned <- read.csv("C:/Users/Shannon/Desktop/Goose_Migration_Sept_2022/Pruned.csv") #251 observations


### rbind the pruned data
final_goose_for_clim<-rbind(Goose_data, Pruned)### Overall we have 27, 980 records

write.csv(final_goose_for_clim, file="Final_goose_for_clim.csv", row.names = F)

### filter for climateNA
breeding_range_clim<-Final_goose_for_clim %>% select(B_SPECIES_NAME, BANDING_YEAR, B_LAT_DECIMAL_DEGREES, B_LON_DECIMAL_DEGREES)

### grab unique breeding locations
breeding_range_clim<-unique(breeding_range_clim) #1,935 obs
breeding_range_clim$el<-c(".")

###  
winter_range_clim<-Final_goose_for_clim %>% select(B_SPECIES_NAME, ENCOUNTER_YEAR, E_LAT_DECIMAL_DEGREES, E_LON_DECIMAL_DEGREES)

### grab unique breeding locations
winter_range_clim<-unique(winter_range_clim) #19,842 obs
winter_range_clim$el<-c(".")



clim_col_names<-c("ID1", "ID2", "lat", "long", "el" )


colnames(breeding_range_clim)<-clim_col_names
colnames(winter_range_clim)<-clim_col_names

write.csv(breeding_range_clim, file="breeding_range_clim.csv", row.names = FALSE)
write.csv(winter_range_clim, file="winter_range_clim.csv", row.names = FALSE)


```



```{r}

#############################################################
### Bayes Models
#############################################################

library(dplyr) ### Data manipulation
library(ggplot2)
# library(tidyverse) #dataframe manipulation and to remove NAs from columns
'%notin%' <- Negate('%in%')

### Import data
FINAL_GOOSE_DATA <- f <- read.csv("data/FINAL_GOOSE_DATA.csv") %>%
  rename(dist = DISTANCE,
         year = ENCOUNTER_YEAR,
         species = B_SPECIES_NAME,
         lat = B_LAT_DECIMAL_DEGREES,
         lon = B_LON_DECIMAL_DEGREES
         ) %>%
  mutate(zy = wiqid::standardize(dist),
         zx = wiqid::standardize(year),
         zlat = wiqid::standardize(lat),
         zlon = wiqid::standardize(lon))

# including just the species that have variation in latitude
flat <- f %>%
  filter(species %notin% c("Atlantic Brant", "Cackling Goose"))

# reduced data set for testing
ind <- sample(x = 1:nrow(f), size = 2000, replace = F)
fr <- f[ind,]

  # format data for JAGS
goose_jags_data <- list(
  y = f$dist,
  x = f$year,
  s = as.numeric(as.factor(f$species)),
  Nsubj = length(unique(f$species)),
  lat=f$lat,
  lon=f$lon,
  zy = f$zy,
  zx = f$zx,
  zlat = f$zlat,
  zlon = f$zlon,
  Ntotal = length(f$dist)
)

  # format data for JAGS (without A. Brant or C. Goose)
goose_jags_data_lat <- list(
  y = flat$dist,
  x = flat$year,
  s = as.numeric(as.factor(flat$species)),
  Nsubj = length(unique(flat$species)),
  lat=flat$lat,
  lon=flat$lon,
  zy = flat$zy,
  zx = flat$zx,
  zlat = flat$zlat,
  zlon = flat$zlon,
  Ntotal = length(flat$dist)
)

# reduced data set
goose_red <- list(
  y = fr$dist,
  x = fr$year,
  s = as.numeric(as.factor(fr$species)),
  Nsubj = length(unique(fr$species)),
  lat=fr$lat,
  lon=fr$lon,
  zy = fr$zy,
  zx = fr$zx,
  zlat = fr$zlat,
  zlon = fr$zlon,
  Ntotal = length(fr$dist)
)

# 1 = "Atlantic Brant"
# 2 = Black Brant
# 3 = Cackling Goose
# 4 = Greater White-fronted Goose
# 5 = Lesser Snow Goose
# 6 = Ross's Goose

# Specify Bayesian model - zscores
#Note: need to fix back transformation of beta0 and beta0mu. This post seems to have the needed info:
#https://stats.stackexchange.com/questions/74622/converting-standardized-betas-back-to-original-variables

```

```{r}
# Write the JAGS model (now allowing each spp. to have its own level of "noise"

#SC notes: "z" in the parameter names are standardized eg. transform the data so that the credible regression lines do not suffer from strong correlations between their slopes and intercepts (prevent MCMC overlap in sampling). "mean centering (eg. re-scaling)" so that their respective SD are = 1, this first chunk below to send the standardized data to JAGS and JAGS will return parameter values, which will then need to be converted back to original scales. This is called the data block

### Model block 

cat(file = "scripts/goose_norm_hb0_hyear_hlat_noint_custom.txt",
"
model {
  for (i in 1:Ntotal) {
    zy[i] ~ dnorm(zbeta0[s[i]] + zbeta1[s[i]] * zx[i] + 
        zbeta2[s[i]] * zlat[i],  
    1/zsigma[s[i]]^2) #, nu)
  }
  # 'hyper' parameters
  #   for normal distributions that species intercepts & slopes come from
  for (j in 1:Nsubj) {
    zbeta0[j] ~ dnorm(zbeta0mu, 1/(zbeta0sigma)^2)
    zbeta1[j] ~ dnorm(zbeta1mu, 1/(zbeta1sigma)^2)
    zsigma[j] ~ dunif( 1.0E-3, 1.0E+3 )
  }
  
  zbeta2[1] ~ dnorm(0, 1/(0.01)^2) # no variation in lat so setting slope to zero
  zbeta2[2] ~ dnorm(zbeta2mu, 1/(zbeta2sigma)^2)
  zbeta2[3] ~ dnorm(0, 1/(0.01)^2) # no variation in lat so setting slope to zero
  zbeta2[4] ~ dnorm(zbeta2mu, 1/(zbeta2sigma)^2)
  zbeta2[5] ~ dnorm(zbeta2mu, 1/(zbeta2sigma)^2)
  zbeta2[6] ~ dnorm(zbeta2mu, 1/(zbeta2sigma)^2)

  # priors on standardized scale:
  zbeta0mu ~ dnorm(0, 1/(10)^2)
  zbeta1mu ~ dnorm(0, 1/(10)^2)
  zbeta2mu ~ dnorm(0, 1/(10)^2)
  zbeta0sigma ~ dunif( 1.0E-3, 1.0E+3 )
  zbeta1sigma ~ dunif( 1.0E-3, 1.0E+3 )
  zbeta2sigma ~ dunif( 1.0E-3, 1.0E+3 )
  # nu <- nuMinusOne+1
  # nuMinusOne ~ dexp(1/29.0)
  
}
"
)
```

# Specify Bayesian model - year + latitude + year:latitude
Note: need to fix back transformation of beta0 and beta0mu. This post seems to have the needed info:
https://stats.stackexchange.com/questions/74622/converting-standardized-betas-back-to-original-variables
```{r}
# Write the JAGS model (now allowing each spp. to have its own level of "noise"

#SC notes: "z" in the parameter names are standardized eg. transform the data so that the credible regression lines do not suffer from strong correlations between their slopes and intercepts (prevent MCMC overlap in sampling). "mean centering (eg. re-scaling)" so that their respective SD are = 1, this first chunk below to send the standardized data to JAGS and JAGS will return parameter values, which will then need to be converted back to original scales. This is called the data block

### Model block 

cat(file = "scripts/goose_norm_hb0_hyear_hlat_int_custom.txt",
"
model {
  for (i in 1:Ntotal) {
    zy[i] ~ dnorm(zbeta0[s[i]] + zbeta1[s[i]] * zx[i] + 
        zbeta2[s[i]] * zlat[i] + zbeta3[s[i]] * zx[i] * zlat[i],  
    1/zsigma[s[i]]^2) #, nu)
  }
  # 'hyper' parameters
  #   for normal distributions that species intercepts & slopes come from
  for (j in 1:Nsubj) {
    zbeta0[j] ~ dnorm(zbeta0mu, 1/(zbeta0sigma)^2)
    zbeta1[j] ~ dnorm(zbeta1mu, 1/(zbeta1sigma)^2)
    zsigma[j] ~ dunif( 1.0E-3, 1.0E+3 )
  }
  
  # setting latitude & interaction priors for geese 2,4,5, and 6

for(i in c(2,4,5,6)) {  
  zbeta2[i] ~ dnorm(zbeta2mu, 1/(zbeta2sigma)^2)
  zbeta3[i] ~ dnorm(zbeta3mu, 1/(zbeta3sigma)^2)
}

# special latitude priors for geese 1 and 3 with no variation in latitude 
for(i in c(1,3)) {
zbeta2[i] ~ dnorm(0, 1/(0.01)^2) # setting slope to zero
zbeta3[i] ~ dnorm(0, 1/(0.01)^2) # setting slope to zero  
}
 
  # priors on standardized scale:
  zbeta0mu ~ dnorm(0, 1/(10)^2)
  zbeta1mu ~ dnorm(0, 1/(10)^2)
  zbeta2mu ~ dnorm(0, 1/(10)^2)
  zbeta3mu ~ dnorm(0, 1/(10)^2)
  zbeta0sigma ~ dunif( 1.0E-3, 1.0E+3 )
  zbeta1sigma ~ dunif( 1.0E-3, 1.0E+3 )
  zbeta2sigma ~ dunif( 1.0E-3, 1.0E+3 )
  zbeta3sigma ~ dunif( 1.0E-3, 1.0E+3 )
  # nu <- nuMinusOne+1
  # nuMinusOne ~ dexp(1/29.0)
  
}
"
)
```
# specify simple model with only year
```{r}
### Model block 

cat(file = "scripts/goose_norm_hb0_hyear.txt",
"
data {
xm <- mean(x)
ym <- mean(y)
xsd <- sd(x)
ysd <- sd(y)
}

model {
  for (i in 1:Ntotal) {
    zy[i] ~ dnorm(zbeta0[s[i]] + zbeta1[s[i]] * zx[i],  
    1/zsigma[s[i]]^2)
  }
  
  # 'hyper' parameters
  #   for normal distributions that species intercepts & slopes come from
  for (j in 1:Nsubj) {
    zbeta0[j] ~ dnorm(zbeta0mu, 1/(zbeta0sigma)^2)
    zbeta1[j] ~ dnorm(zbeta1mu, 1/(zbeta1sigma)^2)
    zsigma[j] ~ dunif( 1.0E-3, 1.0E+3 )
  }
 
  # priors on standardized scale:
  zbeta0mu ~ dnorm(0, 1/(10)^2)
  zbeta1mu ~ dnorm(0, 1/(10)^2)
  zbeta0sigma ~ dunif( 1.0E-3, 1.0E+3 )
  zbeta1sigma ~ dunif( 1.0E-3, 1.0E+3 )
  
  # Tranform to original non-standardized scale
  for ( j in 1:Nsubj ) {
    beta1[j] <- zbeta1[j] * ysd / xsd
    beta0[j] <- zbeta0[j] * ysd + ym - zbeta1[j] * xm * ysd / xsd
    sigma[j] <- zsigma[j] * ysd
  }
  beta1mu <- zbeta1mu * ysd / xsd
  beta0mu <- zbeta0mu * ysd + ym - zbeta1mu * xm * ysd / xsd
  
}
"
)
```

# Run the interaction model
```{r}

modfile <- "scripts/goose_norm_b0_hyear_hlat_noint.txt" # worked
modfile <- "scripts/goose_tdist_b0_hyear_hlat_noint.txt" # hard to converge
modfile <- "scripts/goose_norm_b0_hyear_hlat_hlon_noint.txt" # no conv
modfile <- "scripts/goose_norm_hb0_hyear_hlat_noint_custom.txt" 
modfile <- "scripts/goose_norm_hb0_hyear_hlat_int_custom.txt" 
modfile <- "scripts/goose_norm_hb0_hyear.txt" 

# Run the model with separate SDs by species
jags_mod <- jagsUI::jags(
  data = goose_jags_data,
  model.file = modfile,
  n.iter = 15000,
  n.adapt = 5000,
  parameters.to.save = c(
    "zbeta0",
    "zbeta1",
    "zbeta2",
    "zbeta3",
    "zbeta0mu",
    "zbeta1mu",    
    "zbeta2mu",    
    "zbeta3mu",
    "zbeta1sigma",
    "zbeta2sigma",
    "zbeta3sigma",
    "zsigma",
    "beta0",
    "beta1",
    "sigma",
    "beta0mu",
    "beta1mu"
  ),
  # inits = list(inits, inits, inits),
  n.chains = 3,
  parallel = T,
  n.thin = 3
)

# save the model output as an RDS file (for easy loading later)
saveRDS(jags_mod,
        "output/goose_norm_hb0_hyear_hlat_int_1_3_zerolat.rds")
saveRDS(jags_mod,
        "output/goose_norm_hb0_hyear.rds")

# view basic output of models
jags_mod

# examine traceplots to assess model convergence
jagsUI::traceplot(jags_mod)

```
# more data exploration with latitude
```{r}
library(ggplot2)
ggplot(f) +
  geom_point(aes(x = lat, y = dist, color = year)) +
  facet_wrap(~species) +
  viridis::scale_color_viridis(option = "inferno")

ggsave("dist_v_lat.png", height = 6, width = 8, dpi = 400)

```


# JAGS model run on cluster   
```{r}
mod1 <- 
  readRDS("output/goose_mod_tdist_hierarchical_int_hypers2.rds")

mod <- 
  readRDS("output/goose_norm_hb0_hyear_hlat_noint_1_3_zerolat.rds")

mod

# examine traceplots to assess model convergence
jagsUI::traceplot(mod)

```

# Plot goose response - with interaction
```{r}
# load model
mod <- 
  readRDS("output/goose_norm_hb0_hyear_hlat_int_1_3_zerolat.rds")


# make a dataframe of goose names
geese_names <- f %>%
  group_by(species) %>%
  summarize(minlat = min(lat),
            maxlat = max(lat),
            zminlat = min(zlat),
            zmaxlat = max(zlat)) %>%
  mutate(num = 1:goose_jags_data$Nsub,
         ztrend = round(mod$mean$zbeta1, 5))

# make a dataframe of years
minyr <- min(f$year)
maxyr <- max(f$year)
yearnum <- data.frame(yearnums = seq(minyr:maxyr),
                      years = minyr:maxyr,
                      zyears = sort(unique(f$zx)))

# create 2 empty lists to put posterior samples into
gooseminlatlist <- list()
goosemaxlatlist <- list()
ysminlatlist <- list()
ysmaxlatlist <- list()

# for each goose
for (g in 1:goose_jags_data$Nsubj) {
  # get posterior samples of y predictions for each year
  for (y in 1:30) {
    # put the samples into elements of a list by year
    ysminlatlist[[y]] <- mod$sims.list$zbeta0[, g] +
      mod$sims.list$zbeta1[, g] * yearnum$zyears[y] +
      mod$sims.list$zbeta2[, g] * geese_names$zminlat[g] +
      mod$sims.list$zbeta3[, g]*geese_names$zminlat[g]*yearnum$zyears[y]
    
    ysmaxlatlist[[y]] <- mod$sims.list$zbeta0[, g] +
      mod$sims.list$zbeta1[, g] * yearnum$zyears[y] +
      mod$sims.list$zbeta2[, g] * geese_names$zmaxlat[g] +
      mod$sims.list$zbeta3[, g]*geese_names$zmaxlat[g]*yearnum$zyears[y]

  }
  
  # put the list of predictions into a big list with all geese
  gooseminlatlist[[g]] <- ysminlatlist
  goosemaxlatlist[[g]] <- ysmaxlatlist
  
}

# make an empty list to put summarized posteriors into
goosesum.minlat_list <- list()
goosesum.maxlat_list <- list()

# summarize the posteriors of predicted y for each species and year
for(i in 1:goose_jags_data$Nsubj){
# for each goose
# first make a dataframe of goose name and year
  # then bind it to posterior quantiles (min latitude)
goosesum.minlat_list[[i]] <- 
  cbind(data.frame(name = geese_names$species[i],
                 year = minyr:maxyr,
                 lat = "min"),
      data.frame(
do.call(rbind,
lapply(gooseminlatlist[[i]], 
       FUN = function(x) quantile(x, c(0.025,0.10, 0.5, 0.9, 0.975)))
)
)
)

# max lat
goosesum.maxlat_list[[i]] <- 
  cbind(data.frame(name = geese_names$species[i],
                 year = minyr:maxyr,
                 lat = "max"),
      data.frame(
do.call(rbind,
lapply(goosemaxlatlist[[i]], 
       FUN = function(x) quantile(x, c(0.025,0.10, 0.5, 0.9, 0.975)))
)
)
)

}

meany <- mean(f$dist)
sdy <- sd(f$dist)
sdx <- sd(f$year)

# collapse the list of posterior summaries into a df for plotting
goosesum <- do.call(rbind, goosesum.minlat_list) %>%
  bind_rows(do.call(rbind, goosesum.maxlat_list)) %>%
  rename(q2.5 = 4, q10 = 5, med = 6, q90 = 7, q97.5 = 8) %>%
  mutate(q2.5 = meany+(q2.5*sdy),
         med = meany+(med*sdy),
         q97.5 = meany+(q97.5*sdy),
         q10 = meany+(q10*sdy),
         q90 = meany+(q90*sdy)) %>%
  filter(!(name == "Cackling Goose" & lat == "min"),
         !(name == "Atlantic Brant" & lat == "min"))

# plot the predictions

# make dataframe for trend annotations
maxdist <- goosesum %>% group_by(name) %>% summarize(max = max(q97.5)+100)
ann <- geese_names %>% 
  left_join(maxdist, by = c("species" = "name")) %>%
  mutate(trend = ztrend * sdy / sdx,
    trend2 = paste0(round(trend,2), " km/yr")) %>%
  rename(name = species)

goosesum %>%
  ggplot() +
  geom_ribbon(aes(x = year, ymin = q2.5, 
                  ymax = q97.5, fill = lat, group = lat),
              fill = "gray", alpha = 0.6) +
  geom_ribbon(aes(x = year, ymin = q10, 
                  ymax = q90, group = lat, fill = lat),
              fill = "gray", alpha = 0.6) +
  geom_line(aes(x = year, y = med, linetype = lat),
            color = "black", size = 1) +
  # geom_text(aes(x = 2017, y = max, 
  #                      group = name, label = trend2),
  #           data = ann, hjust = 1, vjust = 1,
  #           size = 3) +
  facet_wrap(~name, scales = "free_y") +
  labs(x = "Year of banding", 
       y = "Mean distance between \n breeding and winter (km)") +
  theme_bw() +
  theme(text = element_text(size = 12),
        strip.text = element_text(size = 10)) +
  guides(linetype = "none")

ggsave("goose_trends_lat_int.png", height = 6, width = 9, dpi = 400)
  
```

# Get goose slopes - model with just year
```{r}
# load model
mod <- 
  readRDS("output/goose_norm_hb0_hyear.rds")

# make a dataframe of goose names
geese_names <- f %>%
  group_by(species) %>%
  summarize(minlat = min(lat),
            maxlat = max(lat),
            zminlat = min(zlat),
            zmaxlat = max(zlat)) %>%
  mutate(num = 1:goose_jags_data$Nsub,
         ztrend = round(mod$mean$zbeta1, 5))

# get the z standardized posteriors for individual and group slope
zbeta1post <- mod$sims.list$zbeta1
zbeta1mupost <- mod$sims.list$zbeta1mu

# get sd of y and x for back transformation
ysd <- sd(f$dist)
xsd <- sd(f$year)

# make a matrix for back transformed individual slope posterior
beta1post <- matrix(NA, nrow = dim(zbeta1post)[1],
                    ncol = dim(zbeta1post)[2])

# make a matrix for back transformed group slope posterior
beta1mupost <- c()

# back transform to original units
for (j in 1:dim(zbeta1post)[2]){    
  for(i in 1:dim(zbeta1post)[1]){
beta1post[i,j] <- zbeta1post[i,j] * ysd / xsd
}
}

for(i in 1:length(zbeta1mupost)){
beta1mupost[i] <- zbeta1mupost[i] * ysd / xsd
}

apply(beta1post, 2, function(x) quantile(x, c(0.025, 0.5, 0.975)))
#            [,1]      [,2]      [,3]      [,4]     [,5]       [,6]
#2.5%  -1.8305096 -6.431631 -5.766886 -2.282869 1.215139 -11.216655
#50%   -1.1182028 -4.447515 -4.724193 -1.045112 2.544196  -9.208264
#97.5% -0.4025533 -2.471479 -3.693968  0.184806 3.868928  -7.205376
# [1] "Atlantic Brant"              "Black Brant"
# [3] "Cackling Goose"              "Greater White-fronted Goose"
# [5] "Lesser Snow Goose"           "Ross's Goose" 

# get mean slope
quantile(beta1mupost, c(0.025, 0.5, 0.975))
#      2.5%       50%     97.5% 
# -8.219674 -3.015526  2.208485 
quantile(zbeta1mupost, c(0.025, 0.5, 0.975))



# make a dataframe of years
minyr <- min(f$year)
maxyr <- max(f$year)
yearnum <- data.frame(yearnums = seq(minyr:maxyr),
                      years = minyr:maxyr,
                      zyears = sort(unique(f$zx)))

# create 2 empty lists to put posterior samples into
gooselist <- list()
yslist <- list()

# for each goose
for (g in 1:goose_jags_data$Nsubj) {
  # get posterior samples of y predictions for each year
  for (y in 1:30) {
    # put the samples into elements of a list by year
    yslist[[y]] <- mod$sims.list$zbeta0[, g] +
      mod$sims.list$zbeta1[, g] * yearnum$zyears[y]

  }
  
  # put the list of predictions into a big list with all geese
  gooseminlatlist[[g]] <- ysminlatlist
  goosemaxlatlist[[g]] <- ysmaxlatlist
  
}

# make an empty list to put summarized posteriors into
goosesum.minlat_list <- list()
goosesum.maxlat_list <- list()

# summarize the posteriors of predicted y for each species and year
for(i in 1:goose_jags_data$Nsubj){
# for each goose
# first make a dataframe of goose name and year
  # then bind it to posterior quantiles (min latitude)
goosesum.minlat_list[[i]] <- 
  cbind(data.frame(name = geese_names$species[i],
                 year = minyr:maxyr,
                 lat = "min"),
      data.frame(
do.call(rbind,
lapply(gooseminlatlist[[i]], 
       FUN = function(x) quantile(x, c(0.025,0.10, 0.5, 0.9, 0.975)))
)
)
)

# max lat
goosesum.maxlat_list[[i]] <- 
  cbind(data.frame(name = geese_names$species[i],
                 year = minyr:maxyr,
                 lat = "max"),
      data.frame(
do.call(rbind,
lapply(goosemaxlatlist[[i]], 
       FUN = function(x) quantile(x, c(0.025,0.10, 0.5, 0.9, 0.975)))
)
)
)

}

meany <- mean(f$dist)
sdy <- sd(f$dist)
sdx <- sd(f$year)

# collapse the list of posterior summaries into a df for plotting
goosesum <- do.call(rbind, goosesum.minlat_list) %>%
  bind_rows(do.call(rbind, goosesum.maxlat_list)) %>%
  rename(q2.5 = 4, q10 = 5, med = 6, q90 = 7, q97.5 = 8) %>%
  mutate(q2.5 = meany+(q2.5*sdy),
         med = meany+(med*sdy),
         q97.5 = meany+(q97.5*sdy),
         q10 = meany+(q10*sdy),
         q90 = meany+(q90*sdy)) %>%
  filter(!(name == "Cackling Goose" & lat == "min"),
         !(name == "Atlantic Brant" & lat == "min"))

# plot the predictions

# make dataframe for trend annotations
maxdist <- goosesum %>% group_by(name) %>% summarize(max = max(q97.5)+100)
ann <- geese_names %>% 
  left_join(maxdist, by = c("species" = "name")) %>%
  mutate(trend = ztrend * sdy / sdx,
    trend2 = paste0(round(trend,2), " km/yr")) %>%
  rename(name = species)

goosesum %>%
  ggplot() +
  geom_ribbon(aes(x = year, ymin = q2.5, 
                  ymax = q97.5, fill = lat, group = lat),
              fill = "gray", alpha = 0.6) +
  geom_ribbon(aes(x = year, ymin = q10, 
                  ymax = q90, group = lat, fill = lat),
              fill = "gray", alpha = 0.6) +
  geom_line(aes(x = year, y = med, linetype = lat),
            color = "black", size = 1) +
  # geom_text(aes(x = 2017, y = max, 
  #                      group = name, label = trend2),
  #           data = ann, hjust = 1, vjust = 1,
  #           size = 3) +
  facet_wrap(~name, scales = "free_y") +
  labs(x = "Year of banding", 
       y = "Mean distance between \n breeding and winter (km)") +
  theme_bw() +
  theme(text = element_text(size = 12),
        strip.text = element_text(size = 10)) +
  guides(linetype = "none")

ggsave("goose_trends_lat_int.png", height = 6, width = 9, dpi = 400)
  
```


# Plot goose response
```{r}
# load model
mod <- 
  readRDS("output/goose_norm_hb0_hyear_hlat_noint_1_3_zerolat.rds")


# make a dataframe of goose names
geese_names <- f %>%
  group_by(species) %>%
  summarize(minlat = min(lat),
            maxlat = max(lat),
            zminlat = min(zlat),
            zmaxlat = max(zlat)) %>%
  mutate(num = 1:goose_jags_data$Nsub,
         ztrend = round(mod$mean$zbeta1, 5))

# make a dataframe of years
minyr <- min(f$year)
maxyr <- max(f$year)
yearnum <- data.frame(yearnums = seq(minyr:maxyr),
                      years = minyr:maxyr,
                      zyears = sort(unique(f$zx)))

# create 2 empty lists to put posterior samples into
gooseminlatlist <- list()
goosemaxlatlist <- list()
ysminlatlist <- list()
ysmaxlatlist <- list()

# for each goose
for (g in 1:goose_jags_data$Nsubj) {
  # get posterior samples of y predictions for each year
  for (y in 1:30) {
    # put the samples into elements of a list by year
    ysminlatlist[[y]] <- mod$sims.list$zbeta0[, g] +
      mod$sims.list$zbeta1[, g] * yearnum$zyears[y] +
      mod$sims.list$zbeta2[, g] * geese_names$zminlat[g]
    
    ysmaxlatlist[[y]] <- mod$sims.list$zbeta0[, g] +
      mod$sims.list$zbeta1[, g] * yearnum$zyears[y] +
      mod$sims.list$zbeta2[, g] * geese_names$zmaxlat[g]
  }
  
  # put the list of predictions into a big list with all geese
  gooseminlatlist[[g]] <- ysminlatlist
  goosemaxlatlist[[g]] <- ysmaxlatlist
  
}

# make an empty list to put summarized posteriors into
goosesum.minlat_list <- list()
goosesum.maxlat_list <- list()

# summarize the posteriors of predicted y for each species and year
for(i in 1:goose_jags_data$Nsubj){
# for each goose
# first make a dataframe of goose name and year
  # then bind it to posterior quantiles (min latitude)
goosesum.minlat_list[[i]] <- 
  cbind(data.frame(name = geese_names$species[i],
                 year = minyr:maxyr,
                 lat = "min"),
      data.frame(
do.call(rbind,
lapply(gooseminlatlist[[i]], 
       FUN = function(x) quantile(x, c(0.025,0.10, 0.5, 0.9, 0.975)))
)
)
)

# max lat
goosesum.maxlat_list[[i]] <- 
  cbind(data.frame(name = geese_names$species[i],
                 year = minyr:maxyr,
                 lat = "max"),
      data.frame(
do.call(rbind,
lapply(goosemaxlatlist[[i]], 
       FUN = function(x) quantile(x, c(0.025,0.10, 0.5, 0.9, 0.975)))
)
)
)

}

meany <- mean(f$dist)
sdy <- sd(f$dist)
sdx <- sd(f$year)

# collapse the list of posterior summaries into a df for plotting
goosesum <- do.call(rbind, goosesum.minlat_list) %>%
  rename(q2.5 = 4, q10 = 5, med = 6, q90 = 7, q97.5 = 8) %>%
  mutate(q2.5 = meany+(q2.5*sdy),
         med = meany+(med*sdy),
         q97.5 = meany+(q97.5*sdy),
         q10 = meany+(q10*sdy),
         q90 = meany+(q90*sdy)) %>%
  filter(!(name == "Cackling Goose" & lat == "min"),
         !(name == "Atlantic Brant" & lat == "min"))

# plot the predictions

# make dataframe for trend annotations
maxdist <- goosesum %>% group_by(name) %>% summarize(max = max(q97.5)+100)
ann <- geese_names %>% 
  left_join(maxdist, by = c("species" = "name")) %>%
  mutate(trend = ztrend * sdy / sdx,
    trend2 = paste0(round(trend,2), " km/yr")) %>%
  rename(name = species)

goosesum %>%
  ggplot() +
  geom_ribbon(aes(x = year, ymin = q2.5, 
                  ymax = q97.5, fill = lat, group = lat),
              fill = "gray", alpha = 0.6) +
  geom_ribbon(aes(x = year, ymin = q10, 
                  ymax = q90, group = lat, fill = lat),
              fill = "gray", alpha = 0.6) +
  geom_line(aes(x = year, y = med, linetype = lat),
            color = "black", size = 1) +
  geom_text(aes(x = 2017, y = max, 
                       group = name, label = trend2),
            data = ann, hjust = 1, vjust = 1,
            size = 3) +
  facet_wrap(~name, scales = "free_y") +
  labs(x = "Year of banding", 
       y = "Mean distance between \n breeding and winter (km)") +
  theme_bw() +
  theme(text = element_text(size = 12),
        strip.text = element_text(size = 10)) +
  guides(linetype = "none")

ggsave("goose_trends_lat2.png", height = 6, width = 9, dpi = 400)
  
```

# testing brms & glm
```{r}
library(brms)

mod <- 
  brms::brm(zy ~ species + species:zx + 
              species:lat + species:zx:zlat, data = f,
            chains = 3, cores = 3, iter = 10000, warmup = 5000)
saveRDS(mod, "goose_int_brms15000.rds")

modglm <- 
  glm(zy ~ species + species:zx + 
              species:lat + species:zx:zlat, data = f)

modglm <- 
  glm(zy ~ species + species:zx + 
              species:lat, data = f)
summary(modglm)

newdata = data.frame(species = "Atlantic Brant",
                     zlat = 0, zx = seq(min(f$zx), max(f$zx), 
                                        length.out = 100))
predict(modglm, )

sjPlot::plot_model(modglm)


saveRDS(modlat, "goose_int_brms.rds")

summary(modlat)
```


```{r}

#############################################################
### Figures
#############################################################
library(rnaturalearth)
world_data <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")

#Figure 1
world_data %>% ggplot() +
    geom_sf(fill = "gray70")+
    coord_sf(xlim = c(-180, -50), ylim =  c(80,15), expand = FALSE)+
    facet_wrap(~B_SPECIES_NAME)+
    geom_point(data= FINAL_GOOSE_DATA, aes(B_LON_DECIMAL_DEGREES, B_LAT_DECIMAL_DEGREES, fill="Banding Location"), color="black", pch=21, size=1.5, stroke=0.09)+ 
    geom_point(data = FINAL_GOOSE_DATA, aes(x = E_LON_DECIMAL_DEGREES, y = E_LAT_DECIMAL_DEGREES, color=ENCOUNTER_YEAR),size=0.8, pch=1)+
    scale_color_viridis()+
    theme_classic()+
    theme(strip.background = element_blank(), strip.text = element_text(hjust = 0, size=12))+ylab("Latitude")+xlab("Longitude")+
    labs(color='Encounter Year')


#Figure 2
maxdist <- goosesum %>% group_by(name) %>% summarize(max = max(q97.5)+100)
ann <- geese_names %>% 
  left_join(maxdist, by = c("species" = "name")) %>%
  mutate(trend = ztrend * sdy / sdx,
    trend2 = paste0(round(trend,2), " km/yr")) %>%
  rename(name = species)

goosesum %>%
  ggplot() +
  geom_ribbon(aes(x = year, ymin = q2.5, 
                  ymax = q97.5, fill = lat, group = lat),
              fill = "gray", alpha = 0.6) +
  geom_ribbon(aes(x = year, ymin = q10, 
                  ymax = q90, group = lat, fill = lat),
              fill = "gray", alpha = 0.6) +
  geom_line(aes(x = year, y = med, linetype = lat),
            color = "black", size = 1) +
  geom_text(aes(x = 2017, y = max, 
                       group = name, label = trend2),
            data = ann, hjust = 1, vjust = 1,
            size = 3) +
  facet_wrap(~name, scales = "free_y") +
  labs(x = "Year of banding", 
       y = "Mean distance between \n breeding and winter (km)") +
  theme_bw() +
  theme(text = element_text(size = 12),
        strip.text = element_text(size = 10)) +
  guides(linetype = "none")

ggsave("goose_trends_lat2.png", height = 6, width = 9, dpi = 400)


,
          strip.text = element_text(size = 10,element_text(hjust = 0),strip.background = element_blank()) +
    guides(linetype = "none")